<?php

require_once 'modelplatform.inc';

// Roles.
define('MODELPLATFORM_MODEL_ROLE_NAME', 'Model');

// Vocabularies.
define('MODELPLATFORM_VOCABULARY_AGE_CATEGORY', 'age_category');

/**
 * Implements hook_menu().
 */
function modelplatform_menu() {
  $items = array();
  $items['admin/configure/modelplatform/documents'] = array(
    'title' => t('Modelplatform documents'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('modelplatform_documents_form'),
    'access arguments' =>  array('moderate modelplatform documents'),
  );

  return $items;
}

/**
 * Implements hook_form_alter().
 */
function modelplatform_form_alter(&$form, &$form_state, $form_id) {
  switch($form_id) {
    case 'user_profile_form':
      if (isset($form['field_model_is_active'])) {
        $access = in_array(MODELPLATFORM_MODEL_ROLE_NAME, $form['#user']->roles);
        $access = $access && user_access('modelplatform administer models');
        $form['field_model_is_active']['#access'] = $access;

        $field_small_business_access = in_array('Customer', $form['#user']->roles);
        $form['field_small_business']['#access'] = !$field_small_business_access;
      }
      break;

    case 'user_pass_reset':
      if (isset($form['message']['#markup'])) {
        drupal_set_title(t('One-time login'));
        $message = t('<p>Click on this button to log in to the site.</p>');
        $form['message']['#markup'] = $message;
      }
      break;

    default:
      // Nothing to do.
  }
}

/**
 * Implements hook_permission().
 */
function modelplatform_permission() {
  $permissions = array(
    'modelplatform administer models' => array(
      'title' => t('Administer models'),
      'description' => t('Can moderate models profiles.'),
    ),
    'moderate modelplatform documents' => array(
      'title' => t('Administer Modelplatform documents'),
      'description' => t('Can moderate modelplatform document templates.'),
    ),
  );

  return $permissions;
}

/**
 * Modelplatform admin settings.
 */
function modelplatform_documents_form($form, &$form_state) {
  $form['parental_approval_for_minors'] = array(
    '#title' => t('Parental approval for minors'),
    '#type' => 'managed_file',
    '#description' => t('Template parental approval for minors.'),
    '#default_value' => variable_get('parental_approval_for_minors', ''),
    '#upload_location' => 'public://document_templates/',
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  return $form;
}

/**
 * Modelplatform admin settings submit.
 *
 * @see modelplatform_documents_form()
 */
function modelplatform_documents_form_submit($form, &$form_state) {
  global $user;
  $file = file_load($form_state['values']['parental_approval_for_minors']);
  $file->status = FILE_STATUS_PERMANENT;
  file_save($file);

  variable_set('parental_approval_for_minors', $file->fid);

  file_usage_add($file, 'modelplatform', 'user', $user->uid);
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function modelplatform_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  global $language ;
  $lang_name = $language->language;
  foreach ($data['tabs'] as $key => &$data_item) {
    if ($data_item['count']) {
      foreach ($data_item['output'] as $i => &$link_item) {
        if ($link_item['#link']['title_callback'] !== 't') {
          $title = $link_item['#link']['title'];

          $query = db_select('locales_source', 'ls');
          $query->condition('ls.source', $title);
          $query->innerJoin('locales_target', 'lt', 'lt.lid = ls.lid');
          $query->condition('lt.language', $lang_name);
          $query->fields('lt', array('translation'));

          $new_title = $query->execute()->fetchfield();
          if (!$new_title) {
            $query = db_select('locales_target', 'lt');
            $query->condition('lt.translation', $title);
            $query->condition('lt.language', $lang_name, '!=');
            $query->innerJoin('locales_source', 'ls', 'lt.lid = ls.lid');
            $query->fields('ls', array('source'));

            $new_title = $query->execute()->fetchfield();
          }
          if ($new_title) {
            $link_item['#link']['title'] = $new_title;
          }
        }
      }
    }
  }
}

/**
 * Implements hook_node_view_alter().
 */
function modelplatform_node_view_alter(&$build) {
  if ($build['#entity_type'] == 'node'
   && $build['#bundle'] == 'node_gallery_gallery'
   && $build['#view_mode'] == 'teaser') {
    $old = $build['links']['node']['#links']['node-readmore'];
    $build['links']['node']['#links']['node-add-image'] = array(
      'title' => t('Add more images'),
      'href' => $old['href'] . '/upload',
      'html' => TRUE,
      'attributes' => array(
        'rel' => 'tag',
        'title' => t('Add more images'),
      ),
    );
    unset($build['links']['node']['#links']['node-readmore']);
    unset($build['links']['comment']);
  }
}
